# Astro Server - Kernel Security Configuration Template
# Generated by Ansible for {{ inventory_hostname }}

# Network Security Settings
net.ipv4.ip_forward = {{ kernel_security.network.ip_forward | default(0) }}
net.ipv6.conf.all.forwarding = 0

# ICMP and Redirect Settings
net.ipv4.conf.all.send_redirects = {{ kernel_security.network.send_redirects | default(0) }}
net.ipv4.conf.default.send_redirects = {{ kernel_security.network.send_redirects | default(0) }}
net.ipv4.conf.all.accept_redirects = {{ kernel_security.network.accept_redirects | default(0) }}
net.ipv4.conf.default.accept_redirects = {{ kernel_security.network.accept_redirects | default(0) }}
net.ipv6.conf.all.accept_redirects = {{ kernel_security.network.accept_redirects | default(0) }}
net.ipv6.conf.default.accept_redirects = {{ kernel_security.network.accept_redirects | default(0) }}

# Source Routing
net.ipv4.conf.all.accept_source_route = {{ kernel_security.network.accept_source_route | default(0) }}
net.ipv4.conf.default.accept_source_route = {{ kernel_security.network.accept_source_route | default(0) }}
net.ipv6.conf.all.accept_source_route = {{ kernel_security.network.accept_source_route | default(0) }}
net.ipv6.conf.default.accept_source_route = {{ kernel_security.network.accept_source_route | default(0) }}

# Reverse Path Filtering
net.ipv4.conf.all.rp_filter = {{ kernel_security.network.rp_filter | default(1) }}
net.ipv4.conf.default.rp_filter = {{ kernel_security.network.rp_filter | default(1) }}

# ICMP Settings
net.ipv4.icmp_echo_ignore_all = {{ kernel_security.network.icmp_echo_ignore_all | default(1) }}
net.ipv4.icmp_echo_ignore_broadcasts = {{ kernel_security.network.icmp_echo_ignore_broadcasts | default(1) }}

# TCP Security
net.ipv4.tcp_syncookies = {{ kernel_security.network.tcp_syncookies | default(1) }}

{% if astro_security_profile in ['aggressive', 'paranoid'] %}
# IPv6 Disable (for high security profiles)
net.ipv6.conf.all.disable_ipv6 = {{ kernel_security.network.disable_ipv6 | default(1) }}
net.ipv6.conf.default.disable_ipv6 = {{ kernel_security.network.disable_ipv6 | default(1) }}
{% endif %}

# Kernel Security Settings
kernel.dmesg_restrict = {{ kernel_security.security.dmesg_restrict | default(1) }}
kernel.kptr_restrict = {{ kernel_security.security.kptr_restrict | default(2) }}
kernel.randomize_va_space = {{ kernel_security.security.randomize_va_space | default(2) }}

{% if astro_security_profile == 'paranoid' %}
# Additional paranoid security settings
kernel.yama.ptrace_scope = 1
kernel.kexec_load_disabled = 1
kernel.unprivileged_bpf_disabled = 1
net.core.bpf_jit_harden = 2
{% endif %}

# Configuration applied on {{ ansible_date_time.iso8601 }}
# Security profile: {{ astro_security_profile }}
# Host: {{ inventory_hostname }}
# OS: {{ ansible_distribution }} {{ ansible_distribution_version }}