# Astro Server - SSH Hardening Configuration Template
# Generated by Ansible for {{ inventory_hostname }}

# Authentication Settings
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PermitEmptyPasswords no
ChallengeResponseAuthentication no
KbdInteractiveAuthentication no
UsePAM yes

# Connection Limits
MaxAuthTries {{ ssh_config.max_auth_tries | default(3) }}
MaxSessions {{ ssh_config.max_sessions | default(2) }}
MaxStartups 10:30:60
LoginGraceTime {{ ssh_config.login_grace_time | default(30) }}

# Protocol Settings
Protocol 2
{% if astro_ssh_port != 22 %}
Port {{ astro_ssh_port }}
{% else %}
Port 22
{% endif %}
AddressFamily inet

# Security Features
StrictModes {{ ssh_config.strict_modes | default('yes') }}
IgnoreRhosts yes
HostbasedAuthentication no
PermitUserEnvironment no

# Forwarding Restrictions
AllowTcpForwarding {{ ssh_config.allow_tcp_forwarding | default('no') }}
AllowAgentForwarding {{ ssh_config.allow_agent_forwarding | default('no') }}
GatewayPorts no
X11Forwarding {{ ssh_config.x11_forwarding | default('no') }}
PermitTunnel no

# Session Management
ClientAliveInterval {{ ssh_config.client_alive_interval | default(300) }}
ClientAliveCountMax {{ ssh_config.client_alive_count_max | default(2) }}
TCPKeepAlive no

# Logging
SyslogFacility AUTH
LogLevel VERBOSE

# Modern crypto (adjust per OS/OpenSSH)
KexAlgorithms {{ ssh_config.kex | default('curve25519-sha256,curve25519-sha256@libssh.org') }}
Ciphers {{ ssh_config.ciphers | default('chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes256-ctr') }}
MACs {{ ssh_config.macs | default('hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256') }}

# Compression
Compression {{ ssh_config.compression | default('no') }}

# Subsystems
Subsystem sftp internal-sftp

# Banner (optional)
{% if ssh_banner_file is defined %}
Banner {{ ssh_banner_file }}
{% endif %}

# Custom SSH configuration for {{ astro_security_profile }} profile
# Applied on {{ ansible_date_time.iso8601 }}