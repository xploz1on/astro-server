# Astro Server - Fail2Ban Configuration Template
# Generated by Ansible for {{ inventory_hostname }}

[DEFAULT]
# Ban Settings
bantime = {{ fail2ban_config.ban_time | default(3600) }}
findtime = {{ fail2ban_config.find_time | default(600) }}
maxretry = {{ fail2ban_config.max_retry | default(3) }}
backend = {{ fail2ban_config.backend | default('systemd') }}

# Email notifications (configure as needed)
{% if fail2ban_config.dest_email is defined %}
destemail = {{ fail2ban_config.dest_email }}
{% endif %}
{% if fail2ban_config.sender_email is defined %}
sender = {{ fail2ban_config.sender_email }}
{% endif %}
mta = {{ fail2ban_config.mta | default('sendmail') }}

# Ban Action
banaction = {{ fail2ban_config.banaction | default('iptables-multiport') }}
banaction_allports = iptables-allports

[sshd]
enabled = true
{% if fail2ban_config.mode is defined %}
mode = {{ fail2ban_config.mode }}
{% endif %}
port = ssh
logpath = %(sshd_log)s
backend = %(sshd_backend)s
bantime = {{ fail2ban_config.ban_time | default(3600) }}
findtime = {{ fail2ban_config.find_time | default(600) }}
maxretry = {{ fail2ban_config.max_retry | default(3) }}

{% if astro_security_profile in ['aggressive', 'paranoid'] %}
[sshd-ddos]
enabled = true
port = ssh
logpath = %(sshd_log)s
backend = %(sshd_backend)s
bantime = {{ fail2ban_config.ban_time | default(3600) }}
findtime = 120
maxretry = 6

[recidive]
enabled = true
logpath = /var/log/fail2ban.log
banaction = iptables-allports
bantime = {{ (fail2ban_config.ban_time | default(3600)) * 7 }}  # 7x longer for repeat offenders
findtime = {{ fail2ban_config.ban_time | default(3600) }}
maxretry = 3
{% endif %}

# Web server protection (if web servers are detected)
{% if 'web-servers' in group_names %}
[apache-auth]
enabled = false
port = http,https
logpath = /var/log/apache2/*error.log
bantime = {{ fail2ban_config.ban_time | default(3600) }}
maxretry = {{ fail2ban_config.max_retry | default(3) }}

[nginx-http-auth]
enabled = false
port = http,https
logpath = /var/log/nginx/error.log
bantime = {{ fail2ban_config.ban_time | default(3600) }}
maxretry = {{ fail2ban_config.max_retry | default(3) }}
{% endif %}

# Configuration applied on {{ ansible_date_time.iso8601 }}
# Security profile: {{ astro_security_profile }}
# Host: {{ inventory_hostname }}